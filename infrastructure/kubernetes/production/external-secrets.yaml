---
# External Secrets Operator - SecretStore for HashiCorp Vault
apiVersion: external-secrets.io/v1beta1
kind: ClusterSecretStore
metadata:
  name: vault-backend
spec:
  provider:
    vault:
      server: "https://vault.kosmos.example.com"
      path: "secret"
      version: "v2"
      auth:
        kubernetes:
          mountPath: "kubernetes"
          role: "kosmos-production"
          serviceAccountRef:
            name: "vault-auth"
            namespace: "kosmos-production"
---
# Database Credentials from Vault
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: kosmos-db-credentials
  namespace: kosmos-production
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: kosmos-db-credentials
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        connection-string: "postgresql://{{ .username }}:{{ .password }}@{{ .host }}:{{ .port }}/{{ .database }}?sslmode=require"
  data:
    - secretKey: username
      remoteRef:
        key: kosmos/production/database
        property: username
    - secretKey: password
      remoteRef:
        key: kosmos/production/database
        property: password
    - secretKey: host
      remoteRef:
        key: kosmos/production/database
        property: host
    - secretKey: port
      remoteRef:
        key: kosmos/production/database
        property: port
    - secretKey: database
      remoteRef:
        key: kosmos/production/database
        property: database
---
# Redis Credentials from Vault
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: kosmos-redis-credentials
  namespace: kosmos-production
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: kosmos-redis-credentials
    creationPolicy: Owner
    template:
      type: Opaque
      data:
        connection-string: "redis://:{{ .password }}@{{ .host }}:{{ .port }}/0"
  data:
    - secretKey: host
      remoteRef:
        key: kosmos/production/redis
        property: host
    - secretKey: port
      remoteRef:
        key: kosmos/production/redis
        property: port
    - secretKey: password
      remoteRef:
        key: kosmos/production/redis
        property: password
---
# Auth Secrets from Vault
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: kosmos-auth-secrets
  namespace: kosmos-production
spec:
  refreshInterval: 24h
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: kosmos-auth-secrets
    creationPolicy: Owner
  data:
    - secretKey: jwt-secret
      remoteRef:
        key: kosmos/production/auth
        property: jwt-secret
    - secretKey: encryption-key
      remoteRef:
        key: kosmos/production/auth
        property: encryption-key
---
# LLM API Keys from Vault
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: kosmos-llm-credentials
  namespace: kosmos-production
spec:
  refreshInterval: 24h
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: kosmos-llm-credentials
    creationPolicy: Owner
  data:
    - secretKey: openai-api-key
      remoteRef:
        key: kosmos/production/llm
        property: openai-api-key
    - secretKey: anthropic-api-key
      remoteRef:
        key: kosmos/production/llm
        property: anthropic-api-key
    - secretKey: google-api-key
      remoteRef:
        key: kosmos/production/llm
        property: google-api-key
---
# Zitadel/SSO Secrets from Vault
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: kosmos-sso-secrets
  namespace: kosmos-production
spec:
  refreshInterval: 24h
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: kosmos-sso-secrets
    creationPolicy: Owner
  data:
    - secretKey: client-id
      remoteRef:
        key: kosmos/production/zitadel
        property: client-id
    - secretKey: client-secret
      remoteRef:
        key: kosmos/production/zitadel
        property: client-secret
