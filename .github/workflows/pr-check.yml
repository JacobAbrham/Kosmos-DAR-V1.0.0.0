name: PR Check

on:
    pull_request:
        types: [opened, synchronize, reopened]

jobs:
    pr-check:
        name: PR Validation
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Validate PR title
              uses: amannn/action-semantic-pull-request@v6
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
              with:
                  types: |
                      feat
                      fix
                      docs
                      style
                      refactor
                      perf
                      test
                      build
                      ci
                      chore
                      revert

            - name: Check for breaking changes
              run: |
                  if git diff origin/main --name-only | grep -E "(schema|migration|api/)" > /dev/null; then
                    echo "⚠️ Breaking change detected - ensure migration plan exists"
                  fi

            - name: Label PR
              uses: actions/labeler@v5
              with:
                  repo-token: ${{ secrets.GITHUB_TOKEN }}

    security-scan:
        name: Security Scan
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@master
              with:
                  scan-type: "fs"
                  scan-ref: "."
                  format: "sarif"
                  output: "trivy-results.sarif"
                  severity: "CRITICAL,HIGH"

            - name: Upload Trivy results
              uses: github/codeql-action/upload-sarif@v3
              if: always()
              with:
                  sarif_file: "trivy-results.sarif"

    code-quality:
        name: Code Quality
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            - name: Run Python linting
              run: |
                  pip install ruff
                  ruff check src/ tests/ --output-format=github

            - name: Set up Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"

            - name: Run frontend linting
              working-directory: frontend
              run: |
                  npm ci
                  npm run lint || true
